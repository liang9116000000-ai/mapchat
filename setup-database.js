// 在浏览器控制台中运行此脚本来初始化数据库表

async function setupDatabase() {
  try {
    console.log('开始创建数据库表...')
    
    const { error: eventsError } = await supabase
      .from('map_events')
      .select('id')
      .limit(1)
    
    if (eventsError && eventsError.code === 'PGRST116') {
      console.log('表不存在，开始创建...')
      
      // 创建事件表
      const { error: createError } = await supabase.rpc('exec_sql', {
        sql: `
          CREATE TABLE IF NOT EXISTS map_events (
            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            title VARCHAR(255) NOT NULL,
            description TEXT NOT NULL,
            type VARCHAR(50) NOT NULL CHECK (type IN ('accident', 'event', 'news', 'other')),
            location JSONB NOT NULL,
            user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
            timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
          );
          
          ALTER TABLE map_events ENABLE ROW LEVEL SECURITY;
          
          CREATE POLICY IF NOT EXISTS "允许所有用户查看事件" ON map_events
            FOR SELECT USING (true);
          
          CREATE POLICY IF NOT EXISTS "用户只能插入自己的事件" ON map_events
            FOR INSERT WITH CHECK (auth.uid() = user_id);
          
          CREATE POLICY IF NOT EXISTS "用户只能更新自己的事件" ON map_events
            FOR UPDATE USING (auth.uid() = user_id);
          
          CREATE POLICY IF NOT EXISTS "用户只能删除自己的事件" ON map_events
            FOR DELETE USING (auth.uid() = user_id);
        `
      })
      
      if (createError) {
        console.error('创建表失败:', createError)
      } else {
        console.log('表创建成功！')
      }
    } else {
      console.log('表已存在，跳过创建')
    }
    
    console.log('数据库初始化完成！')
    return true
  } catch (error) {
    console.error('初始化失败:', error)
    return false
  }
}

// 提供全局访问
window.setupDatabase = setupDatabase
console.log('数据库初始化脚本已加载！在控制台运行: setupDatabase()')