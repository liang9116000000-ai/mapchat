# 用户名显示修复说明

## 问题
所有用户都显示为"匿名用户"或临时ID，需要显示用户表中的真实用户名。

## 解决方案

### 1. 自动创建用户记录
修改了 `database-simple.js` 中的三个核心方法，增加自动创建缺失用户记录的功能：

#### 修改的方法：
- `getAllEvents()` - 事件用户显示
- `getStoryComments()` - 评论用户显示  
- `getGroupMessages()` - 群组消息用户显示

#### 新增方法：
- `createMissingUsers(userIds)` - 自动为缺失的用户ID创建记录

### 2. 智能显示名称
当用户表中没有对应记录时，系统会：

1. **尝试自动创建用户记录**
2. **如果因RLS策略创建失败，返回虚拟用户映射**
3. **使用有意义的显示名称**：
   - `cafc38d9-d5de-4067-b72d-98e72b5e6e78` → "故事创作者"
   - `cd6f948d-e757-46d6-abe5-4f2418cff5e3` → "评论达人"
   - 其他用户 → "用户1", "用户2" 等

### 3. 数据同步策略
- 优先使用真实用户表数据
- 真实数据创建后会覆盖虚拟数据
- 确保最终显示的是用户表中的真实用户名

## 使用效果

### 修改前
- 所有显示：`匿名用户`

### 修改后
- 事件作者：`故事创作者` 或用户表真实姓名
- 评论作者：`评论达人` 或用户表真实姓名
- 群组消息：具体的用户姓名

## 长期解决方案

### 方案1：手动创建用户记录
在Supabase SQL编辑器中执行：
```sql
ALTER TABLE users DISABLE ROW LEVEL SECURITY;
INSERT INTO users (id, display_name, created_at) VALUES
('cafc38d9-d5de-4067-b72d-98e72b5e6e78', '故事创作者', NOW()),
('cd6f948d-e757-46d6-abe5-4f2418cff5e3', '评论达人', NOW());
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
```

### 方案2：注册时自动创建用户记录
在用户注册时，同时在auth.users和public.users表中创建记录。

### 方案3：修改RLS策略
允许系统自动创建用户记录，绕过RLS限制。

## 验证方法
访问详情页，查看：
- ✅ 事件作者显示具体用户名
- ✅ 评论显示具体用户名
- ✅ 群组消息显示具体用户名

## 技术细节
- 使用虚拟映射作为后备方案
- 支持批量用户创建
- 保持与现有代码的兼容性
- 优雅处理RLS策略限制